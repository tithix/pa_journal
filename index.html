<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Action Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                            600: '#475569',
                            500: '#64748b',
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            transition: background-color 0.3s ease;
        }

        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            min-height: 2.5rem;
            background-color: #1e293b;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #334155;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            color: #e2e8f0;
        }

        .tag-remove {
            margin-left: 0.25rem;
            cursor: pointer;
            color: #94a3b8;
        }

        .tag-input {
            flex-grow: 1;
            border: none;
            outline: none;
            min-width: 100px;
            background-color: transparent;
            color: white;
        }

        .journal-entry {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .journal-entry:hover {
            transform: translateY(-2px);
            border-left-color: #3b82f6;
        }

        .image-preview {
            transition: all 0.3s ease;
            border-radius: 0.375rem;
            overflow: hidden;
        }

        .image-preview:hover {
            transform: scale(1.03);
        }

        .time-range-btn {
            transition: all 0.2s ease;
        }

        .time-range-btn.active {
            background-color: #3b82f6;
            color: white;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .glow {
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .chart-type-tab {
            transition: all 0.2s ease;
        }

        .chart-type-tab.active {
            background-color: #3b82f6;
            color: white;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .chart-preview {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1e293b;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chart-preview:hover {
            background-color: #334155;
        }

        .chart-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .file-input {
            display: none;
        }

        .chart-note {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.25rem;
            text-align: center;
            height: 2.5rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .chart-container {
            display: flex;
            flex-direction: column;
        }

        /* Calendar styles */
        .calendar-day {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            background-color: #334155;
        }

        .calendar-day.today {
            background-color: #3b82f6;
            color: white;
        }

        .calendar-day.has-events {
            position: relative;
        }

        .calendar-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            background-color: #3b82f6;
            border-radius: 9999px;
        }

        .calendar-day.selected {
            background-color: #3b82f6;
            color: white;
        }

        .event-importance-high {
            border-left: 3px solid #ef4444;
        }

        .event-importance-medium {
            border-left: 3px solid #f59e0b;
        }

        .event-importance-low {
            border-left: 3px solid #10b981;
        }

        .event-importance-none {
            border-left: 3px solid #64748b;
        }

        /* Modern dropdown styles */
        .dropdown-select {
            position: relative;
        }

        .dropdown-toggle {
            transition: all 0.2s ease;
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            width: 100%;
            text-align: left;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-toggle:hover {
            background-color: #334155 !important;
        }

        .dropdown-toggle:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .dropdown-menu {
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            z-index: 10;
            width: 100%;
            margin-top: 0.25rem;
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .dropdown-item {
            transition: background-color 0.2s ease;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: #e2e8f0;
        }

        .dropdown-item:hover {
            background-color: #334155;
        }

        .dropdown-item.active {
            background-color: #3b82f6;
            color: white;
        }

        .dropdown-toggle.open i {
            transform: rotate(180deg);
        }

        /* Event Modal Styles */
        #eventModal .modal {
            max-width: 500px;
        }

        .event-modal-section {
            margin-bottom: 1.5rem;
        }

        .event-modal-section label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #94a3b8;
        }

        #eventForm input,
        #eventForm select,
        #eventForm textarea {
            width: 100%;
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            color: white;
        }

        #eventForm input:focus,
        #eventForm select:focus,
        #eventForm textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .event-importance-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .importance-high {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .importance-medium {
            background-color: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .importance-low {
            background-color: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .importance-none {
            background-color: rgba(100, 116, 139, 0.2);
            color: #64748b;
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            .grid-cols-1 {
                grid-template-columns: 1fr;
            }

            .lg\:grid-cols-4 {
                grid-template-columns: 1fr;
            }

            .lg\:col-span-1,
            .lg\:col-span-3 {
                grid-column: span 1;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .header-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .header-buttons button {
                width: 100%;
            }

            .modal {
                width: 95%;
                max-height: 90vh;
            }

            #eventModal .modal {
                max-width: 95%;
            }

            .event-modal-section {
                margin-bottom: 1rem;
            }
        }

        #newEntryBtn:hover {
            filter: brightness(1.15) drop-shadow(0 0 8px #3b82f6);
        }

        #newEntryBtn:hover .fa-square-plus {
            filter: brightness(1.3) drop-shadow(0 0 6px #2563eb);
        }

        .delete-hover-red {
            color: #94a3b8;
            transition: color 0.2s;
        }

        #deleteAllBtn:hover .delete-hover-red {
            color: #ef4444;
        }

        .footer-icon {
            color: #94a3b8;
            transition: color 0.2s;
        }

        .footer-icon[aria-label="Discord"]:hover {
            color: #5865F2;
        }

        .footer-icon[aria-label="Twitter"]:hover {
            color: #1da1f2;
        }

        .footer-icon[aria-label="Telegram"]:hover {
            color: #229ED9;
        }

        .footer-icon[aria-label="YouTube"]:hover {
            color: #FF0000;
        }
    </style>
</head>

<body class="bg-dark-900 text-gray-200 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">
                        <i class="fas fa-chart-line text-blue-400 mr-2"></i>
                        Price Action Journal
                    </h1>
                    <p class="text-gray-400 mt-2">Track your market observations and improve your trading skills</p>
                </div>
                <div class="flex flex-wrap gap-2 w-full md:w-auto header-buttons">
                    <button id="importBtn"
                        class="bg-dark-700 hover:bg-dark-600 text-white px-3 py-2 rounded-lg flex items-center transition-all group">
                        <i class="fas fa-cloud-arrow-down mr-2 group-hover:text-blue-400 transition-colors"></i> Import
                    </button>
                    <button id="exportBtn"
                        class="bg-dark-700 hover:bg-dark-600 text-white px-3 py-2 rounded-lg flex items-center transition-all group">
                        <i class="fas fa-cloud-arrow-up mr-2 group-hover:text-green-400 transition-colors"></i> Export
                    </button>
                    <button id="deleteAllBtn" style="background:none;border:none;cursor:pointer;padding:0 0.5em;"
                        title="Delete All">
                        <span class="material-icons delete-hover-red"
                            style="font-size:2.7rem;vertical-align:middle;transition:color 0.2s;">delete</span>
                    </button>
                    <button id="newEntryBtn" style="background:none;border:none;cursor:pointer;padding:0 0.5em;"
                        title="New Entry">
                        <span class="material-icons"
                            style="font-size:2.7rem;color:#3b82f6;vertical-align:middle;transition:color 0.2s;">add_circle</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Sidebar Filters -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-dark-800 p-4 rounded-lg shadow-sm h-fit sticky top-4 border border-dark-700">
                    <h2 class="text-lg font-semibold mb-4 text-white">
                        <i class="fas fa-filter mr-2 text-blue-400"></i>Filters
                    </h2>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Plage de dates</label>
                        <div class="flex space-x-2">
                            <input type="date" id="startDateFilter" class="bg-dark-700 text-white rounded p-2 w-1/2"
                                placeholder="Date début">
                            <input type="date" id="endDateFilter" class="bg-dark-700 text-white rounded p-2 w-1/2"
                                placeholder="Date fin">
                        </div>
                    </div>

                    <div class="mb-4 relative">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Market</label>
                        <div class="dropdown-select">
                            <button
                                class="dropdown-toggle w-full flex justify-between items-center border border-dark-700 rounded p-2 bg-dark-800 text-white text-left">
                                <span id="marketFilterDisplay">All Markets</span>
                                <i class="fas fa-chevron-down text-xs transition-transform duration-200"></i>
                            </button>
                            <div
                                class="dropdown-menu hidden absolute z-10 w-full mt-1 bg-dark-800 border border-dark-700 rounded-lg shadow-lg py-1">
                                <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer" data-value="">All
                                    Markets</div>
                                <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                    data-value="forex">Forex</div>
                                <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                    data-value="stocks">Stocks</div>
                                <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                    data-value="crypto">Cryptocurrency</div>
                                <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                    data-value="indices">Indices</div>
                                <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                    data-value="commodities">Commodities</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Tags</label>
                        <div class="flex flex-wrap gap-2 mt-1" id="tagFilters">
                            <!-- Tags will be added here dynamically -->
                        </div>
                    </div>

                    <button id="applyFilters"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg w-full text-sm mb-2 flex items-center justify-center gap-2">
                        <span class="material-icons"
                            style="font-size:1.3em;vertical-align:middle;">app_registration</span>
                        Apply Filters
                    </button>
                    <button id="clearFilters" class="text-gray-400 hover:text-gray-200 text-sm w-full text-left">
                        Clear all filters
                    </button>
                </div>

                <!-- Calendar and Economic Events -->
                <div class="bg-dark-800 p-4 rounded-lg shadow-sm border border-dark-700 sticky top-[500px]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-white">
                            <i class="fas fa-calendar-alt mr-2 text-blue-400"></i>Calendar
                        </h2>
                        <div class="flex space-x-2">
                            <button id="prevMonth" class="text-gray-400 hover:text-white p-1">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button id="nextMonth" class="text-gray-400 hover:text-white p-1">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="text-center font-medium text-gray-300 mb-2" id="currentMonthYear">
                            <!-- Month and year will be inserted here -->
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-400 mb-2">
                            <div>S</div>
                            <div>M</div>
                            <div>T</div>
                            <div>W</div>
                            <div>T</div>
                            <div>F</div>
                            <div>S</div>
                        </div>
                        <div class="grid grid-cols-7 gap-1" id="calendarDays">
                            <!-- Calendar days will be inserted here -->
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-medium" style="color:#fb923c;">
                                <i class="fas fa-bullhorn mr-2" style="color:#fb923c;"></i>Economic Events
                            </h3>
                            <button id="addEventBtn"
                                class="text-xs bg-blue-500 hover:bg-orange-500 text-white px-2 py-1 rounded transition-colors flex items-center"
                                style="transition:background-color 0.2s;">
                                <i class="fas fa-plus mr-1" style="transition:none;"></i> Add
                            </button>
                        </div>
                        <div class="space-y-2 max-h-60 overflow-y-auto" id="eventsList">
                            <!-- Events will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Journal Entries -->
            <div class="lg:col-span-3">
                <div class="bg-dark-800 p-4 rounded-lg shadow-sm mb-4 border border-dark-700">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-white">
                            <i class="fas fa-book-open mr-2 text-blue-400"></i>Recent Observations
                        </h2>
                        <div class="text-sm text-gray-400" id="entryCount">0 entries</div>
                    </div>
                </div>

                <div id="entriesContainer" class="space-y-4">
                    <!-- Entries will be loaded here -->
                    <div class="text-center py-10 text-gray-500" id="noEntriesMessage">
                        <i class="fas fa-book fa-3x mb-4 text-dark-700"></i>
                        <p class="text-lg">No journal entries yet</p>
                        <p class="text-sm mt-1">Click "New Entry" to add your first observation</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Entry Modal -->
    <div id="entryModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div
            class="bg-dark-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-dark-700 modal">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-white">New Journal Entry</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="entryForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Date & Time (EST)</label>
                        <input type="datetime-local" id="entryDateTime"
                            class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Market</label>
                            <div class="dropdown-select relative">
                                <button type="button" id="entryMarketDropdown"
                                    class="dropdown-toggle w-full flex justify-between items-center border border-dark-700 rounded p-2 bg-dark-800 text-white text-left">
                                    <span id="entryMarketDisplay">Select Market</span>
                                    <i class="fas fa-chevron-down text-xs transition-transform duration-200"></i>
                                </button>
                                <div id="entryMarketMenu"
                                    class="dropdown-menu hidden absolute z-10 w-full mt-1 bg-dark-800 border border-dark-700 rounded-lg shadow-lg py-1">
                                    <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer" data-value="">
                                        <i class="fas fa-globe text-blue-400 mr-2"></i>All Markets
                                    </div>
                                    <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                        data-value="forex"><i class="fas fa-globe-europe text-blue-400 mr-2"></i>Forex
                                    </div>
                                    <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                        data-value="stocks"><i class="fas fa-chart-bar text-green-400 mr-2"></i>Stocks
                                    </div>
                                    <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                        data-value="crypto"><i
                                            class="fab fa-bitcoin text-yellow-400 mr-2"></i>Cryptocurrency</div>
                                    <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                        data-value="indices"><i
                                            class="fas fa-chart-area text-purple-400 mr-2"></i>Indices</div>
                                    <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                        data-value="commodities"><i
                                            class="fas fa-gas-pump text-orange-400 mr-2"></i>Commodities</div>
                                </div>
                                <input type="hidden" id="entryMarket" name="entryMarket" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Session</label>
                            <div class="dropdown-select relative">
                                <button type="button" id="entrySessionDropdown"
                                    class="dropdown-toggle w-full flex justify-between items-center border border-dark-700 rounded p-2 bg-dark-800 text-white text-left">
                                    <span id="entrySessionDisplay">Select Session</span>
                                    <i class="fas fa-chevron-down text-xs transition-transform duration-200"></i>
                                </button>
                                <div id="entrySessionMenu"
                                    class="dropdown-menu hidden absolute z-10 w-full mt-1 bg-dark-800 border border-dark-700 rounded-lg shadow-lg py-1">
                                    <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                        data-value="C1">C1: 6PM-12AM EST</div>
                                    <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                        data-value="C2">C2: 12AM-6AM EST</div>
                                    <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                        data-value="C3">C3: 6AM-12PM EST</div>
                                    <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                        data-value="C4">C4: 12PM-6PM EST</div>
                                    <div class="dropdown-item px-4 py-2 hover:bg-dark-700 cursor-pointer"
                                        data-value="Analysis">Market Analysis</div>
                                </div>
                                <input type="hidden" id="entrySession" name="entrySession" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Symbol (e.g. EUR/USD,
                            BTC/USD)</label>
                        <input type="text" id="entrySymbol"
                            class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white"
                            placeholder="BTC/USD" required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Observation Title</label>
                        <input type="text" id="entryTitle"
                            class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white"
                            placeholder="e.g. Bullish engulfing pattern forming" required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Detailed Notes</label>
                        <textarea id="entryNotes" rows="5"
                            class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white"
                            placeholder="Describe the price action, patterns, and your analysis..." required></textarea>
                    </div>

                    <div class="mb-4">
                        <div class="flex border-b border-dark-700 mb-3">
                            <button type="button" class="chart-type-tab active px-4 py-2 rounded-t-lg"
                                data-chart="chart1">1</button>
                            <button type="button" class="chart-type-tab px-4 py-2 rounded-t-lg" data-chart="chart2">2</button>
                            <button type="button" class="chart-type-tab px-4 py-2 rounded-t-lg" data-chart="chart3">3</button>
                            <button type="button" class="chart-type-tab px-4 py-2 rounded-t-lg" data-chart="chart4">4</button>
                            <button type="button" class="chart-type-tab px-4 py-2 rounded-t-lg" data-chart="chart5">5</button>
                            <button type="button" class="chart-type-tab px-4 py-2 rounded-t-lg" data-chart="chart6">6</button>
                        </div>

                        <div id="chart1-chart-container" class="chart-container">
                            <label class="block text-sm font-medium text-gray-300 mb-1">Chart 1 URL</label>
                            <input type="url" id="entryChart1ImageUrl"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white mb-2"
                                placeholder="https://example.com/chart1.png">
                            <div class="image-preview-container bg-dark-700 rounded p-2 flex justify-center items-center h-32"
                                id="chart1-preview-container">
                                <p class="text-gray-500 text-sm">Chart 1 preview will appear here</p>
                            </div>
                            <textarea id="entryChart1Notes"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white text-xs mt-2"
                                placeholder="Brief notes about Chart 1"
                                rows="2"></textarea>
                        </div>

                        <div id="chart2-chart-container" class="chart-container hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-1">Chart 2 URL</label>
                            <input type="url" id="entryChart2ImageUrl"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white mb-2"
                                placeholder="https://example.com/chart2.png">
                            <div class="image-preview-container bg-dark-700 rounded p-2 flex justify-center items-center h-32"
                                id="chart2-preview-container">
                                <p class="text-gray-500 text-sm">Chart 2 preview will appear here</p>
                            </div>
                            <textarea id="entryChart2Notes"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white text-xs mt-2"
                                placeholder="Brief notes about Chart 2"
                                rows="2"></textarea>
                        </div>

                        <div id="chart3-chart-container" class="chart-container hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-1">Chart 3 URL</label>
                            <input type="url" id="entryChart3ImageUrl"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white mb-2"
                                placeholder="https://example.com/chart3.png">
                            <div class="image-preview-container bg-dark-700 rounded p-2 flex justify-center items-center h-32"
                                id="chart3-preview-container">
                                <p class="text-gray-500 text-sm">Chart 3 preview will appear here</p>
                            </div>
                            <textarea id="entryChart3Notes"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white text-xs mt-2"
                                placeholder="Brief notes about Chart 3"
                                rows="2"></textarea>
                        </div>

                        <div id="chart4-chart-container" class="chart-container hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-1">Chart 4 URL</label>
                            <input type="url" id="entryChart4ImageUrl"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white mb-2"
                                placeholder="https://example.com/chart4.png">
                            <div class="image-preview-container bg-dark-700 rounded p-2 flex justify-center items-center h-32"
                                id="chart4-preview-container">
                                <p class="text-gray-500 text-sm">Chart 4 preview will appear here</p>
                            </div>
                            <textarea id="entryChart4Notes"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white text-xs mt-2"
                                placeholder="Brief notes about Chart 4"
                                rows="2"></textarea>
                        </div>

                        <div id="chart5-chart-container" class="chart-container hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-1">Chart 5 URL</label>
                            <input type="url" id="entryChart5ImageUrl"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white mb-2"
                                placeholder="https://example.com/chart5.png">
                            <div class="image-preview-container bg-dark-700 rounded p-2 flex justify-center items-center h-32"
                                id="chart5-preview-container">
                                <p class="text-gray-500 text-sm">Chart 5 preview will appear here</p>
                            </div>
                            <textarea id="entryChart5Notes"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white text-xs mt-2"
                                placeholder="Brief notes about Chart 5"
                                rows="2"></textarea>
                        </div>

                        <div id="chart6-chart-container" class="chart-container hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-1">Chart 6 URL</label>
                            <input type="url" id="entryChart6ImageUrl"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white mb-2"
                                placeholder="https://example.com/chart6.png">
                            <div class="image-preview-container bg-dark-700 rounded p-2 flex justify-center items-center h-32"
                                id="chart6-preview-container">
                                <p class="text-gray-500 text-sm">Chart 6 preview will appear here</p>
                            </div>
                            <textarea id="entryChart6Notes"
                                class="border border-dark-700 rounded p-2 w-full bg-dark-800 text-white text-xs mt-2"
                                placeholder="Brief notes about Chart 6"
                                rows="2"></textarea>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Tags</label>
                        <div class="tag-input-container">
                            <input type="text" id="tagInput" class="tag-input"
                                placeholder="Type and press enter to add tags">
                        </div>
                        <div class="flex flex-wrap gap-2 mt-2" id="tagsContainer"></div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancelEntry"
                            class="px-4 py-2 border border-dark-700 rounded-lg text-gray-300 hover:bg-dark-700 hover:text-white">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                            Save Entry
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Entry Modal -->
    <div id="viewEntryModal"
        class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div
            class="bg-dark-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-dark-700 modal">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-white" id="viewEntryTitle"></h3>
                    <button id="closeViewModal" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <div class="flex items-center text-sm text-gray-400 mb-2">
                        <span id="viewEntryDateTime" class="mr-3"></span>
                        <span id="viewEntryMarket" class="mr-3"></span>
                        <span id="viewEntrySession"></span>
                    </div>
                    <div class="text-sm font-medium text-gray-300 mb-2">
                        <span id="viewEntrySymbol"></span>
                    </div>
                </div>

                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-300 mb-1">Charts</h4>
                    <div class="chart-grid">
                        <div class="chart-container">
                            <div class="chart-preview" id="view-chart1-chart"
                                onclick="event.stopPropagation(); openChartUrlFromEntry(currentEditingId, 'chart1')">
                                <div id="view-chart1-preview-container"
                                    class="w-full h-full flex items-center justify-center">
                                    <p class="text-gray-500 text-sm">No Chart 1 available</p>
                                </div>
                            </div>
                            <div class="chart-note" id="view-chart1-note"></div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-preview" id="view-chart2-chart"
                                onclick="event.stopPropagation(); openChartUrlFromEntry(currentEditingId, 'chart2')">
                                <div id="view-chart2-preview-container"
                                    class="w-full h-full flex items-center justify-center">
                                    <p class="text-gray-500 text-sm">No Chart 2 available</p>
                                </div>
                            </div>
                            <div class="chart-note" id="view-chart2-note"></div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-preview" id="view-chart3-chart"
                                onclick="event.stopPropagation(); openChartUrlFromEntry(currentEditingId, 'chart3')">
                                <div id="view-chart3-preview-container"
                                    class="w-full h-full flex items-center justify-center">
                                    <p class="text-gray-500 text-sm">No Chart 3 available</p>
                                </div>
                            </div>
                            <div class="chart-note" id="view-chart3-note"></div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-preview" id="view-chart4-chart"
                                onclick="event.stopPropagation(); openChartUrlFromEntry(currentEditingId, 'chart4')">
                                <div id="view-chart4-preview-container"
                                    class="w-full h-full flex items-center justify-center">
                                    <p class="text-gray-500 text-sm">No Chart 4 available</p>
                                </div>
                            </div>
                            <div class="chart-note" id="view-chart4-note"></div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-preview" id="view-chart5-chart"
                                onclick="event.stopPropagation(); openChartUrlFromEntry(currentEditingId, 'chart5')">
                                <div id="view-chart5-preview-container"
                                    class="w-full h-full flex items-center justify-center">
                                    <p class="text-gray-500 text-sm">No Chart 5 available</p>
                                </div>
                            </div>
                            <div class="chart-note" id="view-chart5-note"></div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-preview" id="view-chart6-chart"
                                onclick="event.stopPropagation(); openChartUrlFromEntry(currentEditingId, 'chart6')">
                                <div id="view-chart6-preview-container"
                                    class="w-full h-full flex items-center justify-center">
                                    <p class="text-gray-500 text-sm">No Chart 6 available</p>
                                </div>
                            </div>
                            <div class="chart-note" id="view-chart6-note"></div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-300 mb-1">Tags</h4>
                    <div class="flex flex-wrap gap-2" id="viewEntryTags"></div>
                </div>

                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-300 mb-1">Observation Notes</h4>
                    <div class="bg-dark-700 p-3 rounded text-gray-200" id="viewEntryNotes"></div>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button id="deleteEntryBtn" class="text-red-400 hover:text-red-300 px-4 py-2">
                        <i class="fas fa-trash mr-1"></i> Delete
                    </button>
                    <button id="editEntryBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-edit mr-1"></i> Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div
            class="bg-dark-800 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto border border-dark-700 modal">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-white">
                        <i class="fas fa-calendar-plus mr-2 text-orange-400"></i>
                        Economic Event
                    </h3>
                    <button id="closeEventModal"
                        class="text-gray-400 hover:text-white p-1 rounded-full hover:bg-dark-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="eventForm">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="event-modal-section">
                            <label for="eventDate">Date</label>
                            <input type="date" id="eventDate"
                                class="w-full bg-dark-700 border border-dark-600 rounded p-2 text-white" required>
                        </div>

                        <div class="event-modal-section">
                            <label for="eventTime">Time (EST)</label>
                            <input type="time" id="eventTime"
                                class="w-full bg-dark-700 border border-dark-600 rounded p-2 text-white" required>
                        </div>
                    </div>

                    <div class="event-modal-section">
                        <label for="eventName">Event Name</label>
                        <input type="text" id="eventName"
                            class="w-full bg-dark-700 border border-dark-600 rounded p-2 text-white"
                            placeholder="e.g. Non-Farm Payrolls" required>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="event-modal-section">
                            <label for="eventImportance">Importance</label>
                            <select id="eventImportance"
                                class="w-full bg-dark-700 border border-dark-600 rounded p-2 text-white" required>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="none">None</option>
                            </select>
                        </div>

                        <div class="event-modal-section">
                            <label for="eventCurrency">Currency/Asset</label>
                            <input type="text" id="eventCurrency"
                                class="w-full bg-dark-700 border border-dark-600 rounded p-2 text-white"
                                placeholder="e.g. USD, EUR, BTC">
                        </div>
                    </div>

                    <div class="event-modal-section">
                        <label for="eventNotes">Notes</label>
                        <textarea id="eventNotes" rows="3"
                            class="w-full bg-dark-700 border border-dark-600 rounded p-2 text-white"
                            placeholder="Additional details about the event"></textarea>
                    </div>

                    <div class="event-modal-section border-t border-dark-700 pt-4 mt-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="eventAlarmEnabled" class="form-checkbox h-4 w-4 text-blue-500 bg-dark-700 border-dark-600 rounded focus:ring-blue-500">
                            <span class="text-sm text-gray-300">Activer une alarme de rappel</span>
                        </label>
                        <div id="eventAlarmOptions" class="mt-2 pl-6 hidden">
                             <label for="eventAlarmMinutes" class="block text-xs font-medium text-gray-400 mb-1">Rappeler combien de minutes avant ?</label>
                             <input type="number" id="eventAlarmMinutes" min="1" step="1" value="15" class="w-24 bg-dark-700 border border-dark-600 rounded p-1 text-white text-sm">
                        </div>
                    </div>


                    <div class="flex justify-end space-x-3 pt-6">
                        <button type="button" id="cancelEvent"
                            class="px-4 py-2 border border-dark-600 rounded-lg text-gray-300 hover:bg-dark-700 hover:text-white transition-colors">
                            Cancel
                        </button>
                        <button type="submit"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-save mr-1"></i> Save Event
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" class="file-input" accept=".json">

    <script>
        // Initialize variables
        let entries = JSON.parse(localStorage.getItem('priceActionJournal')) || [];
        let currentEditingId = null;
        let allTags = [];
        let activeFilters = {
            session: null,
            market: null,
            tags: [],
            startDate: null,
            endDate: null
        };

        // Economic events data
        let economicEvents = JSON.parse(localStorage.getItem('economicEvents')) || [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = new Date();

        // DOM Elements
        const newEntryBtn = document.getElementById('newEntryBtn');
        const entryModal = document.getElementById('entryModal');
        const closeModal = document.getElementById('closeModal');
        const cancelEntry = document.getElementById('cancelEntry');
        const entryForm = document.getElementById('entryForm');
        const entriesContainer = document.getElementById('entriesContainer');
        const noEntriesMessage = document.getElementById('noEntriesMessage');
        const viewEntryModal = document.getElementById('viewEntryModal');
        const closeViewModal = document.getElementById('closeViewModal');
        const deleteEntryBtn = document.getElementById('deleteEntryBtn');
        const editEntryBtn = document.getElementById('editEntryBtn');
        const applyFilters = document.getElementById('applyFilters');
        const clearFilters = document.getElementById('clearFilters');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const deleteAllBtn = document.getElementById('deleteAllBtn');
        const fileInput = document.getElementById('fileInput');
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');

        // Calendar elements
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const calendarDays = document.getElementById('calendarDays');
        const eventsList = document.getElementById('eventsList');
        const addEventBtn = document.getElementById('addEventBtn');
        const eventModal = document.getElementById('eventModal');
        const closeEventModal = document.getElementById('closeEventModal');
        const cancelEvent = document.getElementById('cancelEvent');
        const eventForm = document.getElementById('eventForm');
        const eventAlarmEnabled = document.getElementById('eventAlarmEnabled');
        const eventAlarmOptions = document.getElementById('eventAlarmOptions');
        const eventAlarmMinutes = document.getElementById('eventAlarmMinutes');


        // Tag functionality
        const tagInput = document.getElementById('tagInput');
        const tagsContainer = document.getElementById('tagsContainer');
        const tagFilters = document.getElementById('tagFilters');

        // Chart tabs
        const chartTabs = document.querySelectorAll('.chart-type-tab');
        const chartContainers = document.querySelectorAll('.chart-container');
        const viewChartTabs = document.querySelectorAll('.view-chart-tab');
        const viewChartContainers = document.querySelectorAll('.view-chart-container');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            renderEntries();
            updateTagFilters();
            setDefaultDateTime();

            // Set up chart tab switching
            setupChartTabs();
            setupViewChartTabs();

            // Set up image URL previews
            setupImagePreviews();

            // Set up import/export
            setupImportExport();

            // Initialize calendar
            renderCalendar();
            renderEventsForDate(selectedDate);

            // Initialize custom dropdowns
            setupCustomDropdowns();

            // Initialize dropdowns for New Entry Modal
            setupEntryModalDropdowns();

            // Setup alarm checkbox listener
            setupAlarmCheckboxListener();

            // Start checking for alarms
            checkAlarms(); // Check immediately on load
            setInterval(checkAlarms, 60000); // Check every 60 seconds
        });

        // Setup listener for alarm checkbox
        function setupAlarmCheckboxListener() {
            if (eventAlarmEnabled) {
                eventAlarmEnabled.addEventListener('change', () => {
                    if (eventAlarmOptions) {
                        eventAlarmOptions.classList.toggle('hidden', !eventAlarmEnabled.checked);
                    }
                });
            }
        }


        // Delete all entries
        deleteAllBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete ALL entries? This action cannot be undone.')) {
                entries = [];
                localStorage.setItem('priceActionJournal', JSON.stringify(entries));
                renderEntries();
                updateTagFilters();
            }
        });

        // Custom dropdown functionality
        function setupCustomDropdowns() {
            document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
                if (toggle.tagName === 'SELECT') {
                    toggle.addEventListener('focus', () => {
                        toggle.classList.add('open');
                    });
                    toggle.addEventListener('blur', () => {
                        toggle.classList.remove('open');
                    });
                } else {
                    toggle.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const dropdown = toggle.closest('.dropdown-select');
                        const menu = dropdown.querySelector('.dropdown-menu');

                        // Close all other dropdowns
                        document.querySelectorAll('.dropdown-menu').forEach(m => {
                            if (m !== menu) m.classList.add('hidden');
                        });
                        document.querySelectorAll('.dropdown-toggle').forEach(t => {
                            if (t !== toggle) t.classList.remove('open');
                        });

                        // Toggle current dropdown
                        menu.classList.toggle('hidden');
                        toggle.classList.toggle('open');
                    });
                }
            });

            // Handle dropdown item selection
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    const dropdown = item.closest('.dropdown-select');
                    const toggle = dropdown.querySelector('.dropdown-toggle');
                    const display = dropdown.querySelector('#marketFilterDisplay');

                    // Update display
                    display.textContent = item.textContent;

                    // Mark as active
                    dropdown.querySelectorAll('.dropdown-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    item.classList.add('active');

                    // Close menu
                    dropdown.querySelector('.dropdown-menu').classList.add('hidden');
                    toggle.classList.remove('open');

                    // Update filter
                    activeFilters.market = item.dataset.value || null;
                    renderEntries();
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', () => {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.add('hidden');
                });
                document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
                    toggle.classList.remove('open');
                });
            });
        }

        // --- Fix dropdown open/close for New Entry Modal ---
        function setupEntryModalDropdowns() {
            // Market
            entryMarketDropdown.addEventListener('click', function (e) {
                e.stopPropagation();
                // Ferme tous les autres dropdowns
                document.querySelectorAll('.dropdown-menu').forEach(m => {
                    if (m !== entryMarketMenu) m.classList.add('hidden');
                });
                document.querySelectorAll('.dropdown-toggle').forEach(t => {
                    if (t !== entryMarketDropdown) t.classList.remove('open');
                });
                entryMarketMenu.classList.toggle('hidden');
                entryMarketDropdown.classList.toggle('open');
            });
            entryMarketMenu.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function () {
                    entryMarketDisplay.innerHTML = item.innerHTML;
                    entryMarketInput.value = item.dataset.value;
                    entryMarketMenu.classList.add('hidden');
                    entryMarketDropdown.classList.remove('open');
                });
            });
            // Session
            entrySessionDropdown.addEventListener('click', function (e) {
                e.stopPropagation();
                document.querySelectorAll('.dropdown-menu').forEach(m => {
                    if (m !== entrySessionMenu) m.classList.add('hidden');
                });
                document.querySelectorAll('.dropdown-toggle').forEach(t => {
                    if (t !== entrySessionDropdown) t.classList.remove('open');
                });
                entrySessionMenu.classList.toggle('hidden');
                entrySessionDropdown.classList.toggle('open');
            });
            entrySessionMenu.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function () {
                    entrySessionDisplay.textContent = item.textContent;
                    entrySessionInput.value = item.dataset.value;
                    entrySessionMenu.classList.add('hidden');
                    entrySessionDropdown.classList.remove('open');
                });
            });
            // Ferme les dropdowns si clic en dehors
            document.addEventListener('click', function (e) {
                if (!entryMarketDropdown.contains(e.target)) {
                    entryMarketMenu.classList.add('hidden');
                    entryMarketDropdown.classList.remove('open');
                }
                if (!entrySessionDropdown.contains(e.target)) {
                    entrySessionMenu.classList.add('hidden');
                    entrySessionDropdown.classList.remove('open');
                }
            });
        }

        // Calendar functions
        function renderCalendar() {
            // Set month and year title
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            currentMonthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // Get first day of month and total days in month
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            // Clear previous calendar days
            calendarDays.innerHTML = '';

            // Add empty cells for days before first day of month
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'h-8';
                calendarDays.appendChild(emptyDay);
            }

            // Add days of month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';

                // Check if this day has events
                const hasEvents = economicEvents.some(event => {
                    const eventDate = new Date(event.date);
                    return eventDate.getDate() === day &&
                        eventDate.getMonth() === currentMonth &&
                        eventDate.getFullYear() === currentYear;
                });

                if (hasEvents) {
                    dayElement.classList.add('has-events');
                }

                // Check if this is today
                if (day === today.getDate() &&
                    currentMonth === today.getMonth() &&
                    currentYear === today.getFullYear()) {
                    dayElement.classList.add('today');
                }

                // Check if this is the selected date
                if (day === selectedDate.getDate() &&
                    currentMonth === selectedDate.getMonth() &&
                    currentYear === selectedDate.getFullYear()) {
                    dayElement.classList.add('selected');
                }

                dayElement.textContent = day;
                dayElement.addEventListener('click', () => {
                    selectedDate = new Date(currentYear, currentMonth, day);
                    renderCalendar();
                    renderEventsForDate(selectedDate);
                });

                calendarDays.appendChild(dayElement);
            }
        }

        function renderEventsForDate(date) {
            eventsList.innerHTML = '';

            const eventsForDate = economicEvents.filter(event => {
                const eventDate = new Date(event.date);
                return eventDate.getDate() === date.getDate() &&
                    eventDate.getMonth() === date.getMonth() &&
                    eventDate.getFullYear() === date.getFullYear();
            });

            if (eventsForDate.length === 0) {
                eventsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No events scheduled</p>';
                return;
            }

            // Sort events by time
            eventsForDate.sort((a, b) => {
                const timeA = a.time || '00:00';
                const timeB = b.time || '00:00';
                return timeA.localeCompare(timeB);
            });

            eventsForDate.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = `bg-dark-700 p-3 rounded text-sm event-importance-${event.importance || 'none'}`;

                const time = event.time ? `<span class="text-blue-400">${event.time}</span>` : '';
                const currency = event.currency ? `<span class="bg-dark-600 px-2 py-1 rounded text-xs ml-2">${event.currency}</span>` : '';

                // Determine importance badge
                let importanceBadge = '';
                if (event.importance) {
                    importanceBadge = `<span class="event-importance-badge importance-${event.importance}">${event.importance.charAt(0).toUpperCase() + event.importance.slice(1)}</span>`;
                }

                eventElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="font-medium">${event.name}</div>
                        <div class="flex items-center gap-2">
                            ${importanceBadge}
                            ${time} ${currency}
                        </div>
                    </div>
                    ${event.notes ? `<div class="text-gray-400 mt-1">${event.notes}</div>` : ''}
                    <div class="flex justify-end mt-2">
                        <button class="text-xs text-gray-400 hover:text-white mr-2 edit-event" data-id="${event.id}">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <button class="text-xs text-red-400 hover:text-red-300 delete-event" data-id="${event.id}">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                `;

                eventsList.appendChild(eventElement);
            });

            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-event').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const eventId = btn.dataset.id;
                    editEconomicEvent(eventId);
                });
            });

            document.querySelectorAll('.delete-event').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const eventId = btn.dataset.id;
                    deleteEconomicEvent(eventId);
                });
            });
        }

        function editEconomicEvent(eventId) {
            const event = economicEvents.find(e => e.id === eventId);
            if (!event) return;

            // Fill the form with event data
            const eventDate = new Date(event.date);
            const formattedDate = eventDate.toISOString().split('T')[0];
            const formattedTime = event.time || '00:00';

            document.getElementById('eventDate').value = formattedDate;
            document.getElementById('eventTime').value = formattedTime;
            document.getElementById('eventName').value = event.name;
            document.getElementById('eventImportance').value = event.importance || 'none';
            document.getElementById('eventCurrency').value = event.currency || '';
            document.getElementById('eventNotes').value = event.notes || '';

            // Load alarm settings
            eventAlarmEnabled.checked = event.alarmEnabled || false;
            eventAlarmMinutes.value = event.alarmMinutes || 15;
            if (eventAlarmOptions) {
                 eventAlarmOptions.classList.toggle('hidden', !eventAlarmEnabled.checked);
            }


            // Store the event ID in the form
            eventForm.dataset.editingId = eventId;

            // Show the modal
            eventModal.classList.remove('hidden');
        }

        function deleteEconomicEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                economicEvents = economicEvents.filter(e => e.id !== eventId);
                localStorage.setItem('economicEvents', JSON.stringify(economicEvents));
                renderEventsForDate(selectedDate);
                renderCalendar();
            }
        }

        // Month navigation
        prevMonthBtn.addEventListener('click', () => {
            if (currentMonth === 0) {
                currentMonth = 11;
                currentYear--;
            } else {
                currentMonth--;
            }
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            if (currentMonth === 11) {
                currentMonth = 0;
                currentYear++;
            } else {
                currentMonth++;
            }
            renderCalendar();
        });

        // Add event button
        addEventBtn.addEventListener('click', () => {
            // Reset form and set default date to selected date
            eventForm.reset();
            delete eventForm.dataset.editingId;
            // Reset alarm fields specifically
            eventAlarmEnabled.checked = false;
            eventAlarmMinutes.value = 15;
            if (eventAlarmOptions) {
                eventAlarmOptions.classList.add('hidden');
            }


            const formattedDate = selectedDate.toISOString().split('T')[0];
            document.getElementById('eventDate').value = formattedDate;
            document.getElementById('eventTime').value = '00:00';

            // Show the modal
            eventModal.classList.remove('hidden');
        });

        // Close event modal
        closeEventModal.addEventListener('click', () => {
            eventModal.classList.add('hidden');
        });

        cancelEvent.addEventListener('click', () => {
            eventModal.classList.add('hidden');
        });

        // Save event
        eventForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const name = document.getElementById('eventName').value;
            const importance = document.getElementById('eventImportance').value;
            const currency = document.getElementById('eventCurrency').value;
            const notes = document.getElementById('eventNotes').value;
            const alarmEnabled = eventAlarmEnabled.checked;
            const alarmMinutes = parseInt(eventAlarmMinutes.value, 10) || 15; // Default to 15 if invalid

            // Find existing triggered status if editing
            let existingTriggeredStatus = false;
            let existingEvent = null;
            if (eventForm.dataset.editingId) {
                existingEvent = economicEvents.find(e => e.id === eventForm.dataset.editingId);
                existingTriggeredStatus = existingEvent?.alarmTriggered || false;
            }


            const event = {
                id: eventForm.dataset.editingId || Date.now().toString(),
                date,
                time,
                name,
                importance,
                currency,
                notes,
                alarmEnabled,
                alarmMinutes,
                alarmTriggered: existingTriggeredStatus // Preserve triggered status initially
            };

             // Reset triggered status if alarm is disabled or details change significantly
            if (!alarmEnabled || (eventForm.dataset.editingId && existingEvent && (event.date !== existingEvent.date || event.time !== existingEvent.time || event.alarmMinutes !== existingEvent.alarmMinutes))) {
                 event.alarmTriggered = false;
            }


            if (eventForm.dataset.editingId) {
                // Update existing event
                const index = economicEvents.findIndex(e => e.id === eventForm.dataset.editingId);
                if (index !== -1) {
                    economicEvents[index] = event;
                }
            } else {
                // Add new event
                economicEvents.push(event);
            }

            // Save to localStorage
            localStorage.setItem('economicEvents', JSON.stringify(economicEvents));

            // Update UI
            renderCalendar();
            renderEventsForDate(selectedDate);

            // Close modal
            eventModal.classList.add('hidden');
        });

        // Set up chart tab switching
        function setupChartTabs() {
            chartTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    chartTabs.forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    tab.classList.add('active');

                    // Hide all containers
                    chartContainers.forEach(c => c.classList.add('hidden'));
                    // Show selected container
                    const chartType = tab.dataset.chart;
                    document.getElementById(`${chartType}-chart-container`).classList.remove('hidden');
                });
            });
        }

        // Set up view chart tab switching
        function setupViewChartTabs() {
            viewChartTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    viewChartTabs.forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    tab.classList.add('active');

                    // Hide all containers
                    viewChartContainers.forEach(c => c.classList.add('hidden'));
                    // Show selected container
                    const chartType = tab.dataset.chart;
                    document.getElementById(`view-${chartType}-chart-container`).classList.remove('hidden');
                });
            });
        }

        // Set up image URL previews
        function setupImagePreviews() {
            document.getElementById('entryChart1ImageUrl').addEventListener('input', (e) => {
                updateImagePreview(e.target.value, 'chart1-preview-container', 'Chart 1');
            });
            document.getElementById('entryChart2ImageUrl').addEventListener('input', (e) => {
                updateImagePreview(e.target.value, 'chart2-preview-container', 'Chart 2');
            });
            document.getElementById('entryChart3ImageUrl').addEventListener('input', (e) => {
                updateImagePreview(e.target.value, 'chart3-preview-container', 'Chart 3');
            });
            document.getElementById('entryChart4ImageUrl').addEventListener('input', (e) => {
                updateImagePreview(e.target.value, 'chart4-preview-container', 'Chart 4');
            });
            document.getElementById('entryChart5ImageUrl').addEventListener('input', (e) => {
                updateImagePreview(e.target.value, 'chart5-preview-container', 'Chart 5');
            });
            document.getElementById('entryChart6ImageUrl').addEventListener('input', (e) => {
                updateImagePreview(e.target.value, 'chart6-preview-container', 'Chart 6');
            });
        }

        function updateImagePreview(url, containerId, chartName) {
            const container = document.getElementById(containerId);
            if (url && isValidUrl(url)) {
                container.innerHTML = `<img src="${url}" alt="${chartName} preview" class="max-h-full max-w-full object-contain">`;
            } else {
                container.innerHTML = `<p class="text-gray-500 text-sm">${chartName} preview will appear here</p>`;
            }
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // Set up import/export functionality
        function setupImportExport() {
            importBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (Array.isArray(importedData)) {
                            // Ancien format: juste entries
                            entries = importedData;
                            alert('Data imported successfully! (entries only)');
                        } else if (importedData.entries && Array.isArray(importedData.entries)) {
                            entries = importedData.entries;
                            if (Array.isArray(importedData.EconCal)) {
                                economicEvents = importedData.EconCal;
                                alert('Data imported successfully! (entries + economic events)');
                            } else {
                                alert('Data imported successfully! (entries only, economic events unchanged)');
                            }
                        } else {
                            alert('Invalid data format. Please import a valid JSON file.');
                            return;
                        }
                        localStorage.setItem('priceActionJournal', JSON.stringify(entries));
                        localStorage.setItem('economicEvents', JSON.stringify(economicEvents));
                        renderEntries();
                        updateTagFilters();
                        renderCalendar();
                        renderEventsForDate(selectedDate);
                    } catch (error) {
                        alert('Error parsing JSON file. Please check the file format.');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            });

            exportBtn.addEventListener('click', () => {
                if (entries.length === 0 && economicEvents.length === 0) {
                    alert('No entries or economic events to export.');
                    return;
                }
                const dataToExport = {
                    entries: entries,
                    EconCal: economicEvents
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = `price-action-journal-${new Date().toISOString().slice(0, 10)}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            });
        }

        // Set default date and time for new entries
        function setDefaultDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('entryDateTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;

            // Set session based on current hour (local time)
            const hour = now.getHours();
            let session = '';
            if (hour >= 18 || hour < 0) {
                session = 'C1';
            } else if (hour >= 0 && hour < 6) {
                session = 'C2';
            } else if (hour >= 6 && hour < 12) {
                session = 'C3';
            } else {
                session = 'C4';
            }
            document.getElementById('entrySession').value = session;
        }

        // New Entry Modal
        newEntryBtn.addEventListener('click', () => {
            currentEditingId = null;
            entryForm.reset();
            tagsContainer.innerHTML = '';

            // Reset chart URLs and previews
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`entryChart${i}ImageUrl`).value = '';
                document.getElementById(`entryChart${i}Notes`).value = '';
                document.getElementById(`chart${i}-preview-container`).innerHTML = `<p class="text-gray-500 text-sm">Chart ${i} preview will appear here</p>`;
            }

            // Set default date/time and session
            setDefaultDateTime();

            // Show the modal
            entryModal.classList.remove('hidden');
        });

        // Close Modal
        closeModal.addEventListener('click', () => {
            entryModal.classList.add('hidden');
        });

        cancelEntry.addEventListener('click', () => {
            entryModal.classList.add('hidden');
        });

        // Close View Modal
        closeViewModal.addEventListener('click', () => {
            viewEntryModal.classList.add('hidden');
        });

        // Close Event Modal
        closeEventModal.addEventListener('click', () => {
            eventModal.classList.add('hidden');
        });

        cancelEvent.addEventListener('click', () => {
            eventModal.classList.add('hidden');
        });

        // Listen to date filter changes
        startDateFilter.addEventListener('change', () => {
            activeFilters.startDate = startDateFilter.value ? new Date(startDateFilter.value) : null;
        });
        endDateFilter.addEventListener('change', () => {
            activeFilters.endDate = endDateFilter.value ? new Date(endDateFilter.value) : null;
        });

        // Tag Input Functionality
        tagInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && tagInput.value.trim() !== '') {
                e.preventDefault();
                addTag(tagInput.value.trim());
                tagInput.value = '';
            }
        });

        function addTag(tagText) {
            if (!tagsContainer.querySelector(`[data-tag="${tagText}"]`)) {
                const tag = document.createElement('div');
                tag.className = 'tag bg-dark-700 text-gray-200 px-2 py-1 rounded text-sm flex items-center';
                tag.dataset.tag = tagText;

                tag.innerHTML = `
                    ${tagText}
                    <span class="tag-remove ml-1 cursor-pointer" onclick="removeTag(this)">
                        <i class="fas fa-times text-xs"></i>
                    </span>
                `;

                tagsContainer.appendChild(tag);
            }
        }

        function removeTag(element) {
            const tag = element.closest('.tag');
            tag.remove();
        }

        // Save Entry
        entryForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const dateTime = document.getElementById('entryDateTime').value; // valeur brute, sans conversion
            const market = document.getElementById('entryMarket').value;
            const session = document.getElementById('entrySession').value;
            const symbol = document.getElementById('entrySymbol').value;
            const title = document.getElementById('entryTitle').value;
            const notes = document.getElementById('entryNotes').value;
            
            const chartData = {};
            for (let i = 1; i <= 6; i++) {
                chartData[`chart${i}ImageUrl`] = document.getElementById(`entryChart${i}ImageUrl`).value;
                chartData[`chart${i}Notes`] = document.getElementById(`entryChart${i}Notes`).value;
            }

            const tags = Array.from(tagsContainer.querySelectorAll('.tag')).map(tag => tag.dataset.tag);

            const entry = {
                id: currentEditingId || Date.now().toString(),
                dateTime, // stocke la valeur brute
                market,
                session,
                symbol,
                title,
                notes,
                ...chartData, // Spread chart URLs and notes
                tags
            };

            if (currentEditingId) {
                // Update existing entry
                const index = entries.findIndex(e => e.id === currentEditingId);
                if (index !== -1) {
                    entries[index] = entry;
                }
            } else {
                // Add new entry
                entries.unshift(entry);
            }

            // Save to localStorage
            localStorage.setItem('priceActionJournal', JSON.stringify(entries));

            // Update UI
            renderEntries();
            updateTagFilters();

            // Close modal
            entryModal.classList.add('hidden');
        });

        // Render Entries
        function renderEntries(filteredEntries = null) {
            const sessionBgColors = { C1: '#a3a3a3', C2: '#fb7185', C3: '#22c55e', C4: '#3b82f6', Analysis: '#fb923c' };
            let entriesToRender;

            // Détecter si un filtre est actif
            const filtersActive = !!(
                activeFilters.session ||
                activeFilters.market ||
                (activeFilters.tags && activeFilters.tags.length > 0) ||
                activeFilters.startDate ||
                activeFilters.endDate
            );

            if (filteredEntries) {
                entriesToRender = filteredEntries;
            } else if (!filtersActive) {
                // Aucun filtre actif : n'afficher que les entrées du jour
                const today = new Date();
                entriesToRender = entries.filter(entry => {
                    if (!entry.dateTime) return false;
                    const entryDate = new Date(entry.dateTime);
                    return entryDate.getFullYear() === today.getFullYear() &&
                        entryDate.getMonth() === today.getMonth() &&
                        entryDate.getDate() === today.getDate();
                });
            } else {
                // Filtres actifs : logique normale
                entriesToRender = filterEntries();
            }

            if (entriesToRender.length === 0) {
                entriesContainer.innerHTML = noEntriesMessage.outerHTML;
                document.getElementById('entryCount').textContent = '0 entries';
                return;
            }

            entriesContainer.innerHTML = '';
            document.getElementById('entryCount').textContent = `${entriesToRender.length} ${entriesToRender.length === 1 ? 'entry' : 'entries'}`;

            entriesToRender.forEach(entry => {
                const entryElement = document.createElement('div');
                entryElement.className = 'journal-entry bg-dark-800 p-4 rounded-lg shadow-sm border border-dark-700 cursor-pointer fade-in';
                entryElement.dataset.id = entry.id;

                const formattedDate = formatDateTime(entry.dateTime);

                const marketIcon = getMarketIcon(entry.market);

                entryElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-medium text-white">${entry.title}</h3>
                        <span class="text-xs text-gray-400">${formattedDate}</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-400 mb-2">
                        <span class="mr-3">${marketIcon} ${entry.market.charAt(0).toUpperCase() + entry.market.slice(1)}</span>
                        <span class="mr-3">${entry.symbol}</span>
                        <span class="bg-dark-700 px-2 py-1 rounded text-xs" style="background:${sessionBgColors[entry.session] || '#94a3b8'};color:#fff;">
                            ${entry.session === 'Analysis' ? 'An' : entry.session}
                        </span>
                    </div>
                    <div class="text-sm text-gray-300 mb-3 line-clamp-2">${entry.notes}</div>
                    ${[1, 2, 3, 4, 5, 6].some(i => entry[`chart${i}ImageUrl`]) ? `
                        <div class="chart-grid mb-3">
                            ${[1, 2, 3].map(i => `
                            <div class="chart-container">
                                <div class="chart-preview" onclick="event.stopPropagation(); openChartUrlFromEntry('${entry.id}', 'chart${i}')">
                                    ${entry[`chart${i}ImageUrl`] ?
                            `<img src=\"${entry[`chart${i}ImageUrl`]}\" alt=\"Chart ${i}\" class=\"max-h-full max-w-full object-contain\">` :
                            `<p class=\"text-gray-500 text-sm\">No Chart ${i}</p>`}
                                </div>
                                <div class="chart-note">${entry[`chart${i}Notes`] || ''}</div>
                            </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="flex flex-wrap gap-2">
                        ${entry.tags.map(tag => `
                            <span class="bg-dark-700 text-gray-300 px-2 py-1 rounded text-xs">${tag}</span>
                        `).join('')}
                    </div>
                `;

                entryElement.addEventListener('click', () => viewEntry(entry.id));
                entriesContainer.appendChild(entryElement);
            });
        }

        // Open chart URL from view modal
        function openChartUrl(chartType) {
            const entry = entries.find(e => e.id === currentEditingId);
            if (!entry) return;

            const url = entry[`${chartType}ImageUrl`];
            if (url) {
                window.open(url, '_blank');
            }
        }

        // Open chart URL from entry list
        function openChartUrlFromEntry(entryId, chartType) {
            const entry = entries.find(e => e.id === entryId);
            if (!entry) return;

            const url = entry[`${chartType}ImageUrl`];
            if (url) {
                window.open(url, '_blank');
            }
        }

        // Filter entries based on active filters
        function filterEntries() {
            return entries.filter(entry => {
                // Filter by date range if set
                if (activeFilters.startDate) {
                    const entryDate = new Date(entry.dateTime);
                    if (entryDate < activeFilters.startDate) {
                        return false;
                    }
                }
                if (activeFilters.endDate) {
                    const entryDate = new Date(entry.dateTime);
                    // Include the whole end day
                    const endDate = new Date(activeFilters.endDate);
                    endDate.setHours(23, 59, 59, 999);
                    if (entryDate > endDate) {
                        return false;
                    }
                }
                // Filter by session if set
                if (activeFilters.session && entry.session !== activeFilters.session) {
                    return false;
                }

                // Filter by market if set
                if (activeFilters.market && entry.market !== activeFilters.market) {
                    return false;
                }

                // Filter by tags if any are selected
                if (activeFilters.tags.length > 0) {
                    const hasAllTags = activeFilters.tags.every(tag =>
                        entry.tags.includes(tag)
                    );
                    if (!hasAllTags) {
                        return false;
                    }
                }

                return true;
            });
        }

        function getMarketIcon(market) {
            const icons = {
                forex: 'fas fa-globe-europe',
                stocks: 'fas fa-chart-bar',
                crypto: 'fab fa-bitcoin',
                indices: 'fas fa-chart-area',
                commodities: 'fas fa-gas-pump'
            };
            return `<i class="${icons[market] || 'fas fa-chart-line'} text-blue-400"></i>`;
        }

        // View Entry
        function viewEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            currentEditingId = id;

            const formattedDate = formatDateTime(entry.dateTime);

            document.getElementById('viewEntryTitle').textContent = entry.title;
            document.getElementById('viewEntryDateTime').textContent = formattedDate;
            document.getElementById('viewEntryMarket').innerHTML = `<span style="font-weight:bold;">${entry.market.charAt(0).toUpperCase() + entry.market.slice(1)}</span>`;

            const sessionColors = { C1: '#a3a3a3', C2: '#fb7185', C3: '#22c55e', C4: '#3b82f6', Analysis: '#fb923c' };
            const session = entry.session;
            const sessionColor = sessionColors[session] || '#94a3b8';
            document.getElementById('viewEntrySession').innerHTML = `<span style="background:${sessionColor};color:#fff;padding:0.2em 0.7em;border-radius:0.5em;">${session === 'Analysis' ? 'An' : session}</span>`;

            document.getElementById('viewEntrySymbol').textContent = entry.symbol;
            document.getElementById('viewEntryNotes').textContent = entry.notes;

            // Set up chart images and notes
            const h1Container = document.getElementById('view-h1-preview-container');
            // Set up chart images and notes
            for (let i = 1; i <= 6; i++) {
                const chartPreviewContainer = document.getElementById(`view-chart${i}-preview-container`);
                const chartNoteElement = document.getElementById(`view-chart${i}-note`);
                const imageUrl = entry[`chart${i}ImageUrl`];
                const imageNotes = entry[`chart${i}Notes`];

                if (chartPreviewContainer) {
                    chartPreviewContainer.innerHTML = imageUrl
                        ? `<img src="${imageUrl}" alt="Chart ${i}" class="max-h-full max-w-full object-contain">`
                        : `<p class="text-gray-500 text-sm">No Chart ${i} available</p>`;
                }
                if (chartNoteElement) {
                    chartNoteElement.textContent = imageNotes || '';
                }
            }

            // Set up tags
            const tagsContainer = document.getElementById('viewEntryTags');
            tagsContainer.innerHTML = '';

            entry.tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'bg-dark-700 text-gray-300 px-2 py-1 rounded text-xs';
                tagElement.textContent = tag;
                tagsContainer.appendChild(tagElement);
            });

            viewEntryModal.classList.remove('hidden');
        }

        // Delete Entry
        deleteEntryBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete this entry?')) {
                entries = entries.filter(e => e.id !== currentEditingId);
                localStorage.setItem('priceActionJournal', JSON.stringify(entries));
                renderEntries();
                updateTagFilters();
                viewEntryModal.classList.add('hidden');
            }
        });

        // Edit Entry
        editEntryBtn.addEventListener('click', () => {
            const entry = entries.find(e => e.id === currentEditingId);
            if (!entry) return;

            viewEntryModal.classList.add('hidden');

            // Fill the form with entry data
            document.getElementById('entryDateTime').value = entry.dateTime; // valeur brute, sans conversion
            document.getElementById('entryMarket').value = entry.market;
            document.getElementById('entrySession').value = entry.session;
            document.getElementById('entrySymbol').value = entry.symbol;
            document.getElementById('entryTitle').value = entry.title;
            document.getElementById('entryNotes').value = entry.notes;

            for (let i = 1; i <= 6; i++) {
                document.getElementById(`entryChart${i}ImageUrl`).value = entry[`chart${i}ImageUrl`] || '';
                document.getElementById(`entryChart${i}Notes`).value = entry[`chart${i}Notes`] || '';
                updateImagePreview(entry[`chart${i}ImageUrl`], `chart${i}-preview-container`, `Chart ${i}`);
            }

            // Add tags
            tagsContainer.innerHTML = '';
            entry.tags.forEach(tag => addTag(tag));

            // Show the edit modal
            entryModal.classList.remove('hidden');
        });

        // Update tag filters in sidebar
        function updateTagFilters() {
            // Collect all unique tags from entries
            allTags = [...new Set(entries.flatMap(entry => entry.tags))];

            tagFilters.innerHTML = '';

            if (allTags.length === 0) {
                tagFilters.innerHTML = '<p class="text-sm text-gray-500">No tags yet</p>';
                return;
            }

            allTags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = `cursor-pointer ${activeFilters.tags.includes(tag) ? 'bg-blue-500 text-white' : 'bg-dark-700 text-gray-300'} px-2 py-1 rounded text-xs`;
                tagElement.textContent = tag;
                tagElement.dataset.tag = tag;
                tagElement.addEventListener('click', () => toggleTagFilter(tag));
                tagFilters.appendChild(tagElement);
            });
        }

        // Toggle tag filter
        function toggleTagFilter(tag) {
            const index = activeFilters.tags.indexOf(tag);
            if (index === -1) {
                activeFilters.tags.push(tag);
            } else {
                activeFilters.tags.splice(index, 1);
            }

            updateTagFilters();
            renderEntries();
        }

        // Clear all filters
        clearFilters.addEventListener('click', () => {
            // Reset all filters
            activeFilters = {
                session: null,
                market: null,
                tags: [],
                startDate: null,
                endDate: null
            };

            // Reset UI elements
            document.querySelector('.dropdown-item[data-value=""]').click();
            startDateFilter.value = '';
            endDateFilter.value = '';

            // Update and render
            updateTagFilters();
            renderEntries();
        });

        // Make removeTag function available globally
        window.removeTag = removeTag;
        window.openChartUrlFromEntry = openChartUrlFromEntry;

        // Dropdown for Market in New Entry Modal
        const entryMarketDropdown = document.getElementById('entryMarketDropdown');
        const entryMarketMenu = document.getElementById('entryMarketMenu');
        const entryMarketDisplay = document.getElementById('entryMarketDisplay');
        const entryMarketInput = document.getElementById('entryMarket');

        entryMarketDropdown.addEventListener('click', function (e) {
            e.stopPropagation();
            entryMarketMenu.classList.toggle('hidden');
            entryMarketDropdown.classList.toggle('open');
        });
        entryMarketMenu.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', function () {
                entryMarketDisplay.innerHTML = item.innerHTML;
                entryMarketInput.value = item.dataset.value;
                entryMarketMenu.classList.add('hidden');
                entryMarketDropdown.classList.remove('open');
            });
        });

        document.addEventListener('click', function (e) {
            if (!entryMarketDropdown.contains(e.target)) {
                entryMarketMenu.classList.add('hidden');
                entryMarketDropdown.classList.remove('open');
            }
        });

        // Dropdown for Session in New Entry Modal
        const entrySessionDropdown = document.getElementById('entrySessionDropdown');
        const entrySessionMenu = document.getElementById('entrySessionMenu');
        const entrySessionDisplay = document.getElementById('entrySessionDisplay');
        const entrySessionInput = document.getElementById('entrySession');

        entrySessionDropdown.addEventListener('click', function (e) {
            e.stopPropagation();
            entrySessionMenu.classList.toggle('hidden');
            entrySessionDropdown.classList.toggle('open');
        });
        entrySessionMenu.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', function () {
                entrySessionDisplay.textContent = item.textContent;
                entrySessionInput.value = item.dataset.value;
                entrySessionMenu.classList.add('hidden');
                entrySessionDropdown.classList.remove('open');
            });
        });

        document.addEventListener('click', function (e) {
            if (!entrySessionDropdown.contains(e.target)) {
                entrySessionMenu.classList.add('hidden');
                entrySessionDropdown.classList.remove('open');
            }
        });

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            const [datePart, timePart] = dateTimeStr.split('T');
            if (!datePart || !timePart) return dateTimeStr;
            const [year, month, day] = datePart.split('-');
            const [hour, minute] = timePart.split(':');
            return `${day}/${month}/${year.slice(2)} - ${hour}:${minute}`;
        }

        // --- Alarm Notification Logic ---
        function checkAlarms() {
            const now = new Date();
            let updated = false;
            // console.log("Checking alarms at", now); // Debug log

            economicEvents.forEach((event, index) => {
                if (event.alarmEnabled && !event.alarmTriggered && event.date && event.time) {
                    const [year, month, day] = event.date.split('-');
                    const [hour, minute] = event.time.split(':');
                    
                    // Construct event date object (assuming EST for now, needs refinement for proper timezone handling)
                    // WARNING: Simple date construction might be inaccurate due to timezones/DST.
                    // A robust solution would use a library or more complex date parsing based on a defined timezone (e.g., UTC storage + local conversion).
                    // For now, we proceed with local time interpretation for simplicity.
                    const eventDateTime = new Date(year, month - 1, day, hour, minute);

                    if (isNaN(eventDateTime.getTime())) {
                        console.error("Invalid date/time for event:", event);
                        return; // Skip invalid event
                    }

                    const alarmTime = new Date(eventDateTime.getTime() - (event.alarmMinutes * 60000)); // Subtract minutes

                    // console.log(`Event: ${event.name}, Event Time: ${eventDateTime}, Alarm Time: ${alarmTime}, Now: ${now}`); // Debug log

                    if (now >= alarmTime) {
                        console.log(`Triggering alarm for: ${event.name}`); // Debug log
                        showNotification(event);
                        economicEvents[index].alarmTriggered = true; // Mark as triggered
                        updated = true;
                    }
                }
            });

            if (updated) {
                localStorage.setItem('economicEvents', JSON.stringify(economicEvents));
                // Optionally re-render events if visual indication of triggered alarm is needed
                // renderEventsForDate(selectedDate); 
            }
        }

        function showNotification(event) {
            if (!("Notification" in window)) {
                alert("Ce navigateur ne supporte pas les notifications de bureau");
            } else if (Notification.permission === "granted") {
                // If it's okay let's create a notification
                const notification = new Notification(`Rappel: ${event.name}`, {
                    body: `L'événement est prévu pour ${event.time} (EST).`,
                    icon: 'https://cdn-icons-png.flaticon.com/512/1041/1041847.png' // Optional: Add an icon URL
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then((permission) => {
                    // If the user accepts, let's create a notification
                    if (permission === "granted") {
                        const notification = new Notification(`Rappel: ${event.name}`, {
                           body: `L'événement est prévu pour ${event.time} (EST).`,
                           icon: 'https://cdn-icons-png.flaticon.com/512/1041/1041847.png' // Optional: Add an icon URL
                        });
                    }
                });
            }
            // At last, if the user has denied notifications, and you
            // want to be annoying, you could ask them to change their settings.
        }

    </script>

    <footer
        style="position:fixed;left:0;right:0;bottom:0;z-index:50;background:rgba(15,23,42,0.97);color:#94a3b8;font-size:0.85rem;font-family:Inter,sans-serif;text-align:center;padding:0.5rem 0;letter-spacing:0.03em;display:flex;justify-content:center;align-items:center;gap:1.5rem;">
        <span style="display:flex;align-items:center;gap:0.4em;">
            <i class="fa-solid fa-copyright"></i> 2025 Powered by <span
                style="background:linear-gradient(90deg,#3b82f6,#2563eb);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-fill-color:transparent;font-weight:400;">3dr!ves</span>
        </span>
        <span style="display:flex;align-items:center;gap:1em;">
            <a href="#" target="_blank" aria-label="Discord" class="footer-icon"><i
                    class="fab fa-discord fa-lg"></i></a>
            <a href="#" target="_blank" aria-label="Twitter" class="footer-icon"><i
                    class="fab fa-twitter fa-lg"></i></a>
            <a href="#" target="_blank" aria-label="Telegram" class="footer-icon"><i
                    class="fab fa-telegram fa-lg"></i></a>
            <a href="#" target="_blank" aria-label="YouTube" class="footer-icon"><i
                    class="fab fa-youtube fa-lg"></i></a>
        </span>
    </footer>
</body>

</html>

